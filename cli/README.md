# Ksec CLI 

<a href="../README.md"><<<<<<< Назад в README.md</a>

CLI выполняет запросы в REST API 

### Установка
```bash
# Из корня проекта: 
make cli 

# вручную 
go build -o ksec ./cli
```

После выполнения команды, появится бинарный файл ksec

### url API:

```bash
./ksec login -u admin -s https://my.api
```
CLI сохранит url и будет использовать его для дальнейших запросов. Чтобы изменить url, нужно выполнить команду заново

### Команды 

```bash
./ksec login   # авторизация по логину и паролю
./ksec create  # создание секрета 
./ksec update  # обновление секрена
./ksec delete  # удаление секрена
./ksec list    # список всех секретов
./ksec get     # информация о секрете
./ksec help    # список команд
```

### Быстрый старт

``` bash
### Авторизация 
./ksec login -u admin -p adminpass

### Создать Opaque секрет из JSON
./ksec create my-db-secret --type Opaque -n default --data-file ./secret-data.json

### Создать AutoGenerated секрет
./ksec create my-app-secret --type AutoGenerated --length 32 --key db_pass --key api_token -n default

### Посмотреть секрет
./ksec get my-app-secret -n default

### Обновить метки/аннотации
./ksec update my-app-secret -n default --label env=prod --annotation owner=admin

### Удалить
./ksec delete my-app-secret -n default --force
```
# Команды
### `ksec create NAME`

Создаёт SecretClaim + автоматически генерирует/создаёт Secret.

### В CLI доступно два типа секретов:
- Opaque - стандартный тип для записи пользовательских данных
- AutoGenerated - этот тип автоматически генерирует секреты по заданному конфигу

### Примеры: 
``` bash
# Opaque (данные из файла)
./ksec create my-db-secret --type Opaque --data-file ./secret-data.json -n staging

# AutoGenerated (множественные ключи)
./ksec create my-app --type AutoGenerated --length 32 --key db_pass --key api_token --encoding base64 -n prod

# AutoGenerated (CSV ключи)
./ksec create simple --type AutoGenerated --length 16 --key "db_pass,db_user" -n default
```

### `ksec update NAME`

`Обновляет SecretClaim → триггерит reconcile Secret.

### С помощью update можно: 
- Обновить данные Opaque секрета
- Обновить конфиг AutoGenerated секрета 
- Перегенерировать секреты AutoGenerated
- Сменить тип секрета Opaque -> AutoGenerated
- Обновить метаданные (Labels, Annotations)

### Примеры:

``` bash
# Только метки/аннотации (partial update)
./ksec update test-secret --label env=prod --label team=devops -n default
./ksec update test-secret --annotation owner=admin --annotation version=v2 -n default

# Opaque → новые данные
./ksec update test-secret --type Opaque --data-file new-data.json -n default

# AutoGenerated → регенерация
./ksec update test-auto --regenerate -n default

# Смена типа Opaque → AutoGenerated
./ksec update test-opaque --type AutoGenerated --length 32 --keys "db_pass" -n default
```

### `ksec get NAME`

Показывает SecretClaim + актуальные метаданные Secret (если status.synced=true).

```bash
./ksec get my-secret       # default namespace
./ksec get my-secret -n staging # staging namespace
```
### `ksec list`

Список SecretClaims в namespace.

``` bash
./ksec list                    # default namespace
./ksec list -n staging         # staging namespace
```
### `ksec delete NAME`

Удаляет SecretClaim + связанный Secret.

```bash
./ksec delete my-secret --force # без подтверждения
./ksec delete my-secret   # с подтверждением (y/N)
```
### `ksec login`

Получить JWT токен.

``` bash
./ksec login -u admin -p adminpass -s https://server.url
./ksec login -u admin   # интерактивный пароль
```


## Тест кейсы для мануального тестирования: 

## CREATE

| №  | Сценарий                          | Команда                                                                                                       | Ожидаемый результат                      | HTTP статус | Примечание                                  |
|----|-----------------------------------|---------------------------------------------------------------------------------------------------------------|------------------------------------------|-------------|---------------------------------------------|
| 1  | Opaque с файлом                   | `./ksec create my-db-secret --type Opaque -n staging --data-file ./secret-data.json`                            | ✅ SecretClaim создан                     | 201         | data из JSON файла                          |
| 2  | Opaque пустой                     | `./ksec create empty-secret --type Opaque -n default`                                                           | ✅ SecretClaim создан                     | 201         | data: {}                                    |
| 3  | AutoGenerated множественные ключи | `./ksec create my-app-secret --type AutoGenerated --length 32 --key db_pass --key db_user -k api_token -n prod` | ✅ SecretClaim создан                     | 201         | DataKeys: ["db_pass","db_user","api_token"] |
| 4  | AutoGenerated CSV ключ            | `./ksec create simple-secret --type AutoGenerated --length 16 --key "db_pass,db_user" -n default`               | ✅ SecretClaim создан                     | 201         | DataKeys: ["db_pass","db_user"]             |
| 5  | Без --type                        | `./ksec create invalid-secret `                                                                                 | ❌ "flag --type is required"              | -           | CLI валидация                               |
| 6  | Неправильный тип                  | `./ksec create wrong-type --type InvalidType -n default `                                                       | ❌ "invalid secret type: InvalidType"     | -           | CLI валидация                               |
| 7  | AutoGenerated без --length        | `./ksec create no-length --type AutoGenerated --key db_pass -n default`                                         | ❌ "flag --length is required"            | -           | CLI валидация                               |
| 8  | AutoGenerated без ключей          | `./ksec create no-keys --type AutoGenerated --length 16 -n default `                                            | ❌ "at least one --key required"          | -           | CLI валидация                               |
| 9  | Слишком короткая длина            | `./ksec create short-secret --type AutoGenerated --length 4 --key db_pass -n default `                          | ❌ "generation length must be at least 8" | -           | CLI валидация                               |
| 10 | AutoGenerated + data-file         | `./ksec create conflict --type AutoGenerated --data-file data.json --length 16 --key db_pass -n default`        | ❌ "Wrong request format"                 | 400         | Handler валидация                           |
| 11 | Opaque + generation params        | `./ksec create opaque-wrong --type Opaque --length 16 --key db_pass -n default       `                          | ❌ "Wrong request format"                 | 400         | Handler валидация                           |
| 12 | K8s валидация length              | `./ksec create k8s-invalid --type AutoGenerated --length 4 --key db_pass -n default        `                    | ❌ "invalid generationConfig"             | 500         | K8s слой                                    |
| 13 | Namespace без прав                | `./ksec create forbidden-ns --type Opaque -n restricted-ns      `                                               | ❌ "Access denied"                        | 403         | Auth проверка                               |


## UPDATE 

| №  | Сценарий                           | Команда                                                                                        | Ожидаемый результат                   | HTTP статус | Примечание                                |
|----|------------------------------------|------------------------------------------------------------------------------------------------|---------------------------------------|-------------|-------------------------------------------|
| 1  | Update labels только               | `./ksec update test-secret -n default --label env=prod --label team=devops      `                | ✅ SecretClaim обновлён                | 200         | Только labels изменены                    |
| 2  | Update annotations                 | `./ksec update test-secret -n default --annotation owner=admin --annotation version=v2    `      | ✅ SecretClaim обновлён                | 200         | Только annotations изменены               |
| 3  | Opaque → Opaque с data-file        | `./ksec update test-secret --type Opaque -n default --data-file new-data.json        `           | ✅ SecretClaim обновлён                | 200         | Data из файла, Generation=nil             |
| 4  | AutoGenerated → regenerate         | `./ksec update test-auto --type AutoGenerated --regenerate -n default  `                         | ✅ SecretClaim обновлён                | 200         | ReconcileTrigger изменён                  |
| 5  | AutoGenerated → новые ключи        | `./ksec update test-auto --type AutoGenerated --length 32 --keys "new_pass,new_user" -n default` | ✅ SecretClaim обновлён                | 200         | GenerationConfig обновлён                 |
| 6  | Opaque → AutoGenerated             | `./ksec update test-auto --type AutoGenerated --length 16 --keys "db_pass" -n default     `      | ✅ SecretClaim обновлён                | 200         | Требует generationConfig                  |
| 7  | AutoGenerated → Opaque             | `./ksec update test-auto --type Opaque --data-file data.json -n default     `                    | ✅ SecretClaim обновлён                | 200         | Data обновлён, Generation=nil             |
| 8  | AutoGenerated + data-file          | `./ksec update test-auto--type AutoGenerated --data-file data.json --length 16 -n default `      | ❌ "Wrong request format"              | 400         | Handler: data && config конфликт          |
| 9  | Opaque + generation params         | `./ksec update test-secret --type Opaque --length 16 --keys db_pass -n default       `           | ❌ "Wrong request format"              | 400         | Handler: config && !data                  |
| 10 | AutoGenerated без generationConfig | `./ksec update test-auto --type AutoGenerated -n default        `                                | ❌ "generationConfig must be provided" | 500         | K8s: нет существующего Generation         |
| 11 | Invalid generationConfig           | `./ksec update test-auto --type AutoGenerated --length 4 --keys db_pass -n default       `       | ❌ "invalid generationConfig"          | 500         | K8s: length < 8                           |
| 12 | Несуществующий SecretClaim         | `./ksec update nonexistent --type AutoGenerated -n default         `                             | ❌ "failed to read SecretClaim"        | 500         | K8s: GetSecretClaim failed                |
| 13 | Только encoding (без length/keys)  | `./ksec update test-auto --type AutoGenerated --encoding symbols -n default          `           | ✅ SecretClaim обновлён                | 500         | Неявная попытка обновить только -encoding |

## DELETE 

| №  | Сценарий                                  | Команда                                          | Ожидаемый результат       | HTTP статус | Примечание                 |
|----|-------------------------------------------|--------------------------------------------------|---------------------------|-------------|----------------------------|
| 1  | Удаление существующего SecretClaim        | `./ksec delete my-secret -n default --force  `     | ✅ SecretClaim удалён      | 200         | Без подтверждения          |
| 2  | Удаление с интерактивным подтверждением   |` ./ksec delete my-secret -n default   `            | ✅ SecretClaim удалён      | 200         | Требует "y" в терминале    |
| 3  | Удаление с force (несуществующий)         | `./ksec delete nonexistent -n default --force  `   | ✅ OK (игнорирует 404)     | 200         | K8s: IgnoreNotFound        |
| 4  | Удаление в другом namespace               | `./ksec delete my-secret -n staging --force   `    | ✅ SecretClaim удалён      | 200         | Namespace указан           |
| 5  | Без namespace (default)                   | `./ksec delete my-secret --force `                 | ✅ SecretClaim удалён      | 200         | Использует default         |
| 6  | Namespace без прав                        | `./ksec delete my-secret -n restricted-ns --force` | ❌ "Access denied"         | 403         | Auth проверка              |
| 7  | Developer роль                            | `./ksec delete my-secret -n default --force `      | ❌ "Access denied"         | 403         | claims.Role == "developer" |
| 8  | Несуществующий SecretClaim (интерактивно) | `./ksec delete nonexistent -n default      `       | ✅ OK (игнорирует 404)     | 200         | K8s: IgnoreNotFound        |
| 9  | Без имени SecretClaim                     | `./ksec delete -n default --force  `               | ❌ "accepts exactly 1 arg" | -           | Cobra: ExactArgs(1)        |
| 10 | Слишком много аргументов                  | `./ksec delete secret1 secret2 -n default --force` | ❌ "accepts exactly 1 arg" | -           | Cobra валидация            |

## GET 

|   | Сценарий                            | Команда                                | Ожидаемый результат                   | HTTP статус | Примечание                                              |
|---|-------------------------------------|----------------------------------------|---------------------------------------|-------------|---------------------------------------------------------|
| 1 | Существующий Opaque (synced)        | `./ksec get my-opaque-secret -n default `| ✅ SecretClaim + actual Secret data    | 200         | status.synced=true, возвращает data                     |
| 2 | Существующий AutoGenerated (synced) |` ./ksec get my-auto-secret -n default  ` | ✅ SecretClaim + generated Secret data | 200         | status.synced=true, возвращает сгенерированные значения |
| 3 | Default namespace                   |` ./ksec get my-secret  `                 | ✅ SecretClaim из default              | 200         | -nне указан                                             |
| 4 | Namespace без прав                  | `./ksec get my-secret -n restricted-ns `| ❌ "Access denied"                     | 403         | Auth проверка                                           |
| 5 | Developer роль                      | `./ksec get my-secret -n default  `      | ✅ Работает                            | 200         | Нет проверки роли (только namespace)                    |
| 6 | Несуществующий SecretClaim          | `./ksec get nonexistent -n default  `    | ❌ "failed to get SecretClaim"         | 500         | K8s: GetSecretClaim возвращает ошибку                   |
| 7 | Без имени SecretClaim               | `./ksec get -n default  `                | ❌ "accepts exactly 1 arg"             | -           | Cobra: ExactArgs(1)                                     |
| 8 | Слишком много аргументов            | `./ksec get secret1 secret2 -n default`  | ❌ "accepts exactly 1 arg"             | -           | Cobra валидация                                         |
| 9 | Secret без SecretClaim              | `./ksec get secret-only -n default`      | ❌ "failed to get SecretClaim"         | 500         | SecretClaim не найден                                   |


## LIST 
| 1 | Список в namespace с SecretClaims | ./ksec list -n default        | ✅ Список SecretClaims           | 200 | Возвращает все SecretClaim в namespace |
|---|-----------------------------------|-------------------------------|---------------------------------|-----|----------------------------------------|
| 2 | Default namespace                 | `./ksec list     `              | ✅ Список из default             | 200 | -nне указан                            |
| 3 | Пустой namespace                  |` ./ksec list -n empty-ns  `     | ✅ Пустой список[]               | 200 | Нет SecretClaims                       |
| 4 | Namespace без прав                |` ./ksec list -n restricted-ns  `| ❌ "Access denied"               | 403 | Auth проверка                          |
| 5 | Developer роль                    |` ./ksec list -n default      `  | ❌ "Access denied"               | 403 | Только namespace check                 |
| 6 | Namespace не существует           | `./ksec list -n nonexistent-ns `| ❌ "failed to list SecretClaims" | 500 | K8s List ошибка                        |
| 7 | Cluster-wide (все namespaces)     |` ./ksec list         `          | ✅ Только default                | 200 | Нет поддержки all-namespaces           |


## LOGIN 

| № | Сценарий                  | Команда                                  | Ожидаемый результат             | HTTP статус | Примечание                 |
|---|---------------------------|------------------------------------------|---------------------------------|-------------|----------------------------|
| 1 | Успешный логин            | `./ksec login -u admin -p adminpass `      | ✅ JWT токен получен             | 200         | Сохраняется в config/token |
| 2 | Без пароля (интерактивно) | `./ksec login -u admin`                    | ✅ JWT токен                     | 200         | Требует ввод пароля        |
| 3 | Без username              | `./ksec login -p adminpass `               | ❌ "flag --username is required" | -           | Cobra: MarkFlagRequired    |
| 4 | Неправильный username     | `./ksec login -u nonexistent -p adminpass |` ❌ "Wrong username/password"     | 401         | Handler: user == nil       |
| 5 | Неправильный пароль       | `./ksec login -u admin -p wrongpass  `     | ❌ "Wrong username/password"     | 401         | Handler: CheckPasswordHash |
| 6 | Пустой username           | `./ksec login -u "" -p adminpass`          | ❌ "Wrong username/password"     | 401         | user == nil                |
| 7 | Пустой пароль             |` ./ksec login -u admin -p ""  `            | ❌ "Wrong username/password"     | 401         | CheckPasswordHash          |
| 8 | Без параметров            | `./ksec login       `                      | ❌ "flag --username is required" | -           | Cobra валидация            |
